services:
  # =========================
  # DOZZLE
  # =========================
  dozzle:
    image: amir20/dozzle:latest
    ports:
      - "9999:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # =========================
  # OTEL COLLECTOR
  # =========================
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    networks: [obsnet]
    command: ["--config", "/etc/otel-collector-config.yaml"]
    volumes:
      - ./infra/otel/otel-collector.yaml:/etc/otel-collector-config.yaml:ro
    # ports:
    #   - "4317:4317" # OTLP gRPC
    #   - "4318:4318" # OTLP HTTP
    #   - "9411:9411" # Zipkin

  # =========================
  # TEMPO
  # =========================
  tempo:
    image: grafana/tempo:latest
    networks: [obsnet]
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./infra/tempo/tempo.yaml:/etc/tempo.yaml:ro
    ports:
      - "3200:3200"   # tempo query
      # - "4317"        # otlp grpc (optional)
      # - "4318"        # otlp http (optional)

  # =========================
  # GRAFANA
  # =========================
  grafana:
    image: grafana/grafana:latest
    networks: [obsnet]
    ports:
      - "3001:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin

  # =========================
  # STARTUP PROBE
  # =========================
  startup-probe:
    image: probe:dev
    networks: [obsnet]
    command: ["sh", "-c", "sleep infinity"]
    depends_on:
      step-ca:
        condition: service_healthy
      auth-envoy:
        condition: service_started
      user-envoy:
        condition: service_started
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://auth-envoy:19000/ready | grep -q LIVE \
          && curl -fsS http://user-envoy:19000/ready | grep -q LIVE"
        ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s


  # =========================
  # E2E PROBE
  # =========================
  e2e-probe:
    image: probe:dev
    networks: [obsnet]
    command: ["sh", "-c", "sleep infinity"]
    depends_on:
      startup-probe:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://auth-envoy:18081/healthz >/dev/null \
          && grpc_health_probe -addr=user-envoy:19081 >/dev/null"
        ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  # =========================
  # STEP-CA (shared)
  # =========================
  step-ca:
    image: smallstep/step-ca:latest
    networks: [ctrlnet]
    volumes:
      - ./infra/security/mtls/pki/stepca:/home/step
      - ./infra/security/mtls/pki/secrets:/run/secrets:ro
    ports:
      - "9000:9000"
    command: ["step-ca", "/home/step/config/ca.json", "--password-file", "/run/secrets/ca.password"]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- --no-check-certificate https://127.0.0.1:9000/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  # =========================
  # INGRESS-ENVOY
  # =========================
  ingress-envoy:
    image: envoyproxy/envoy:v1.36.4
    networks: [edgenet, obsnet]
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./infra/envoy/ingress-envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./infra/security/mtls/pki/ingress-sds/run:/var/run/step-sds:ro
      - ./infra/security/tls/localhost:/etc/envoy/certs:ro
    depends_on:
      ingress-sds:
        condition: service_healthy
    ports:
      - "8081:18080"
      - "19000:19000"
  
  ingress-sds:
    image: smallstep/step-sds:latest
    networks: [ctrlnet]
    volumes:
      - ./infra/security/mtls/pki/ingress-sds:/home/step
      - ./infra/security/mtls/pki/secrets:/run/secrets:ro
      - ./infra/security/mtls/pki/ingress-sds/run:/var/run/step-sds
    depends_on:
      step-ca:
        condition: service_healthy
    command:
      - /bin/sh
      - -c
      - >
        set -eux;
        rm -f /var/run/step-sds/sds.sock;
        ls -la /var/run/step-sds;
        exec step-sds run /home/step/config/sds.json
        --password-file /run/secrets/ingress.sds.password
        --provisioner-password-file /run/secrets/ca.password
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/step-sds/sds.sock && pgrep -f 'step-sds' >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  # =========================
  # AUTH: app + envoy + step-sds
  # =========================
  auth:
    image: auth:dev
    env_file:
      - .env.local
    network_mode: "service:auth-envoy"
    depends_on:
      startup-probe:
        condition: service_healthy
    # The app listens ONLY on:
    #   127.0.0.1:8080 (HTTP)
    #   127.0.0.1:9090 (gRPC)
    # No ports exposed

  auth-envoy:
    image: envoyproxy/envoy:v1.36.4
    networks: [authnet, obsnet]
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./infra/envoy/auth-envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./infra/security/mtls/pki/auth-sds/run:/var/run/step-sds:ro
    depends_on:
      auth-sds:
        condition: service_healthy
    ports:
      # HTTP: auth-envoy:18080 -> auth:8080
      # - "8081:18080"
      # gRPC: auth-envoy:19080 -> auth:9090
      # Envoy admin
      - "19001:19000"   # http://localhost:19001/stats/prometheus
    healthcheck:
      test: ["CMD-SHELL", "bash -lc ': </dev/tcp/127.0.0.1/19000'"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s

  auth-sds:
    image: smallstep/step-sds:latest
    networks: [ctrlnet]
    volumes:
      - ./infra/security/mtls/pki/auth-sds:/home/step
      - ./infra/security/mtls/pki/secrets:/run/secrets:ro
      - ./infra/security/mtls/pki/auth-sds/run:/var/run/step-sds
    depends_on:
      step-ca:
        condition: service_healthy
    command:
      - /bin/sh
      - -c
      - >
        set -eux;
        rm -f /var/run/step-sds/sds.sock;
        ls -la /var/run/step-sds;
        exec step-sds run /home/step/config/sds.json
        --password-file /run/secrets/auth.sds.password
        --provisioner-password-file /run/secrets/ca.password
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/step-sds/sds.sock && pgrep -f 'step-sds' >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s


  # =========================
  # USER: app + envoy + step-sds
  # =========================
  user:
    image: user:dev
    env_file:
      - .env.local
    network_mode: "service:user-envoy"
    depends_on:
      startup-probe:
        condition: service_healthy
    # The app listens ONLY on:
    #   127.0.0.1:8080 (HTTP)
    #   127.0.0.1:9090 (gRPC)
    # No ports exposed

  user-envoy:
    image: envoyproxy/envoy:v1.36.4
    networks: [usernet, obsnet]
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./infra/envoy/user-envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./infra/security/mtls/pki/user-sds/run:/var/run/step-sds:ro
    ports:
      # HTTP: user-envoy:18080 -> user:8080
      # gRPC: user-envoy:19080 -> user:9090
      # Envoy admin (metrics, config dump)
      - "19002:19000"   # http://localhost:19002/stats/prometheus
    depends_on:
      user-sds:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bash -lc ': </dev/tcp/127.0.0.1/19000'"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s

  user-sds:
    image: smallstep/step-sds:latest
    networks: [ctrlnet]
    volumes:
      - ./infra/security/mtls/pki/user-sds:/home/step
      - ./infra/security/mtls/pki/secrets:/run/secrets:ro
      - ./infra/security/mtls/pki/user-sds/run:/var/run/step-sds
    depends_on:
      step-ca:
        condition: service_healthy
    command:
      - /bin/sh
      - -c
      - >
        set -eux;
        rm -f /var/run/step-sds/sds.sock;
        ls -la /var/run/step-sds;
        exec step-sds run /home/step/config/sds.json
        --password-file /run/secrets/user.sds.password
        --provisioner-password-file /run/secrets/ca.password
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/step-sds/sds.sock && pgrep -f 'step-sds' >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

networks:
  authnet: {}
  usernet: {}
  edgenet: {}
  ctrlnet: {}
  obsnet: {}