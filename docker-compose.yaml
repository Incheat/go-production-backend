services:
  # =========================
  # OBSERVABILITY
  # =========================

  dozzle:
    image: amir20/dozzle:latest
    ports:
      - "9999:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  prometheus:
    image: prom/prometheus:latest
    networks:
      - obsnet
    # ports:
    #   - "9090:9090"
    command:
      - --config.file=/etc/prometheus/prometheus.yaml
    volumes:
      - ./infra/obs/prometheus/prometheus.yaml:/etc/prometheus/prometheus.yaml:ro

  loki:
    image: grafana/loki:latest
    networks:
      - obsnet
    # ports:
    #   - "3100:3100"
    command:
      - -config.file=/etc/loki/config.yaml
    volumes:
      - ./infra/obs/loki/loki.yaml:/etc/loki/config.yaml:ro

  promtail:
    image: grafana/promtail:latest
    networks:
      - obsnet
    command:
      - -config.file=/etc/promtail/config.yaml
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./infra/obs/promtail/promtail.yaml:/etc/promtail/config.yaml:ro
      - promtail-positions:/tmp

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    networks:
      - obsnet
    command:
      - --config
      - /etc/otel-collector-config.yaml
    volumes:
      - ./infra/obs/otel/otel-collector.yaml:/etc/otel-collector-config.yaml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    # ports:
    #   - "4317:4317" # OTLP gRPC
    #   - "4318:4318" # OTLP HTTP
    #   - "9411:9411" # Zipkin

  tempo:
    image: grafana/tempo:latest
    networks:
      - obsnet
    ports:
      # - "3200:3200" # tempo query
      # - "4317"     # otlp grpc (optional)
      # - "4318"     # otlp http (optional)
    command:
      - -config.file=/etc/tempo.yaml
    volumes:
      - ./infra/obs/tempo/tempo.yaml:/etc/tempo.yaml:ro

  grafana:
    image: grafana/grafana:latest
    networks:
      - obsnet
    ports:
      - "3000:3000"
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    volumes:
      - ./infra/obs/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      prometheus:
        condition: service_started
      loki:
        condition: service_started
      tempo:
        condition: service_started

  # =========================
  # PROBES
  # =========================

  startup-probe:
    image: probe:dev
    networks:
      - obsnet
    command:
      - sh
      - -c
      - sleep infinity
    depends_on:
      step-ca:
        condition: service_healthy
      auth-envoy:
        condition: service_started
      user-envoy:
        condition: service_started
    healthcheck:
      test:
        - CMD-SHELL
        - >
          curl -fsS http://auth-envoy:19000/ready | grep -q LIVE &&
          curl -fsS http://user-envoy:19000/ready | grep -q LIVE
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  e2e-probe:
    image: probe:dev
    networks:
      - obsnet
    command:
      - sh
      - -c
      - sleep infinity
    depends_on:
      startup-probe:
        condition: service_healthy
    healthcheck:
      test:
        - CMD-SHELL
        - >
          curl -fsS http://auth-envoy:18081/healthz >/dev/null &&
          grpc_health_probe -addr=user-envoy:19081 >/dev/null
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  # =========================
  # PKI / SDS
  # =========================

  step-ca:
    image: smallstep/step-ca:latest
    networks:
      - ctrlnet
    ports:
      - "9000:9000"
    command:
      - step-ca
      - /home/step/config/ca.json
      - --password-file
      - /run/secrets/ca.password
    volumes:
      - ./infra/security/mtls/pki/stepca:/home/step
      - ./infra/security/mtls/pki/secrets:/run/secrets:ro
    healthcheck:
      test:
        - CMD-SHELL
        - wget -qO- --no-check-certificate https://127.0.0.1:9000/health >/dev/null
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  ingress-sds:
    image: smallstep/step-sds:latest
    networks:
      - ctrlnet
    depends_on:
      step-ca:
        condition: service_healthy
    volumes:
      - ./infra/security/mtls/pki/ingress-sds:/home/step
      - ./infra/security/mtls/pki/secrets:/run/secrets:ro
      - ./infra/security/mtls/pki/ingress-sds/run:/var/run/step-sds
    command:
      - /bin/sh
      - -c
      - >
        set -eux;
        rm -f /var/run/step-sds/sds.sock;
        ls -la /var/run/step-sds;
        exec step-sds run /home/step/config/sds.json
        --password-file /run/secrets/ingress.sds.password
        --provisioner-password-file /run/secrets/ca.password
    healthcheck:
      test:
        - CMD-SHELL
        - test -S /var/run/step-sds/sds.sock && pgrep -f 'step-sds' >/dev/null
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  auth-sds:
    image: smallstep/step-sds:latest
    networks:
      - ctrlnet
    depends_on:
      step-ca:
        condition: service_healthy
    volumes:
      - ./infra/security/mtls/pki/auth-sds:/home/step
      - ./infra/security/mtls/pki/secrets:/run/secrets:ro
      - ./infra/security/mtls/pki/auth-sds/run:/var/run/step-sds
    command:
      - /bin/sh
      - -c
      - >
        set -eux;
        rm -f /var/run/step-sds/sds.sock;
        ls -la /var/run/step-sds;
        exec step-sds run /home/step/config/sds.json
        --password-file /run/secrets/auth.sds.password
        --provisioner-password-file /run/secrets/ca.password
    healthcheck:
      test:
        - CMD-SHELL
        - test -S /var/run/step-sds/sds.sock && pgrep -f 'step-sds' >/dev/null
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  user-sds:
    image: smallstep/step-sds:latest
    networks:
      - ctrlnet
    depends_on:
      step-ca:
        condition: service_healthy
    volumes:
      - ./infra/security/mtls/pki/user-sds:/home/step
      - ./infra/security/mtls/pki/secrets:/run/secrets:ro
      - ./infra/security/mtls/pki/user-sds/run:/var/run/step-sds
    command:
      - /bin/sh
      - -c
      - >
        set -eux;
        rm -f /var/run/step-sds/sds.sock;
        ls -la /var/run/step-sds;
        exec step-sds run /home/step/config/sds.json
        --password-file /run/secrets/user.sds.password
        --provisioner-password-file /run/secrets/ca.password
    healthcheck:
      test:
        - CMD-SHELL
        - test -S /var/run/step-sds/sds.sock && pgrep -f 'step-sds' >/dev/null
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  # =========================
  # EDGE
  # =========================

  ingress-envoy:
    image: envoyproxy/envoy:v1.36.4
    labels:
      - obs.logs=true
    networks:
      - edgenet
      - obsnet
    ports:
      - "8081:18080"
      - "19000:19000"
    command:
      - -c
      - /etc/envoy/envoy.yaml
      - --log-level
      - info
    volumes:
      - ./infra/envoy/ingress-envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./infra/security/mtls/pki/ingress-sds/run:/var/run/step-sds:ro
      - ./infra/security/tls/localhost:/etc/envoy/certs:ro
    depends_on:
      ingress-sds:
        condition: service_healthy

  # =========================
  # AUTH: app + envoy
  # =========================

  auth-envoy:
    image: envoyproxy/envoy:v1.36.4
    labels:
      - obs.logs=true
    networks:
      - authnet
      - obsnet
    ports:
      - "19001:19000" # http://localhost:19001/stats/prometheus
    command:
      - -c
      - /etc/envoy/envoy.yaml
      - --log-level
      - info
    volumes:
      - ./infra/envoy/auth-envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./infra/security/mtls/pki/auth-sds/run:/var/run/step-sds:ro
    depends_on:
      auth-sds:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/step-sds/sds.sock && pgrep -f 'step-sds' >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s

  auth:
    image: auth:dev
    labels:
      - obs.logs=true
    env_file:
      - .env.local
    network_mode: service:auth-envoy
    depends_on:
      startup-probe:
        condition: service_healthy
    # The app listens ONLY on:
    #   127.0.0.1:8080 (HTTP)
    #   127.0.0.1:9090 (gRPC)

  # =========================
  # USER: app + envoy
  # =========================

  user-envoy:
    image: envoyproxy/envoy:v1.36.4
    labels:
      - obs.logs=true
    networks:
      - usernet
      - obsnet
    ports:
      - "19002:19000" # http://localhost:19002/stats/prometheus
    command:
      - -c
      - /etc/envoy/envoy.yaml
      - --log-level
      - info
    volumes:
      - ./infra/envoy/user-envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./infra/security/mtls/pki/user-sds/run:/var/run/step-sds:ro
    depends_on:
      user-sds:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/step-sds/sds.sock && pgrep -f 'step-sds' >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s

  user:
    image: user:dev
    labels:
      - obs.logs=true
    env_file:
      - .env.local
    network_mode: service:user-envoy
    depends_on:
      startup-probe:
        condition: service_healthy
    # The app listens ONLY on:
    #   127.0.0.1:8080 (HTTP)
    #   127.0.0.1:9090 (gRPC)

networks:
  authnet: {}
  usernet: {}
  edgenet: {}
  ctrlnet: {}
  obsnet: {}

volumes:
  promtail-positions: {}
